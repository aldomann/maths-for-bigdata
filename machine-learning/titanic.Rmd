---
title: 'Delivery 3: Isa Stuff'
author: "Alfredo Hern√°ndez"
date: "15 June 2018"
output:
  html_document:
    theme: cosmo
    highlight: tango
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
subtitle: Mathematics for Big Data
---

# Introduction

The sinking of the RMS Titanic is one of the most infamous shipwrecks in history.  On April 15, 1912, during her maiden voyage, the Titanic sank after colliding with an iceberg, killing 1502 out of 2224 passengers and crew. This sensational tragedy shocked the international community and led to better safety regulations for ships.

One of the reasons that the shipwreck led to such loss of life was that there were not enough lifeboats for the passengers and crew. Although there was some element of luck involved in surviving the sinking, some groups of people were more likely to survive than others, such as women, children, and the upper-class.

## Objective

The objective is to build a model with Machine Learning that can predict the survival chance of a given individual performing a binary classification.

## Data

The features are the following:

| Feature  | Description                                | Key                                            |
|----------|--------------------------------------------|------------------------------------------------|
| `survival` | Survival                                   | `0` = No, `1` = Yes                                |
| `pclass`   | Ticket class                               | `1` = 1st, `2` = 2nd, `3` = 3rd                      |
| `sex`      | Sex                                        |                                                |
| `age`      | Age in years                               |                                                |
| `sibsp`    | # of siblings / spouses aboard the Titanic |                                                |
| `parch`    | # of parents / children aboard the Titanic |                                                |
| `ticket`   | Ticket number                              |                                                |
| `fare`     | Passenger fare                             |                                                |
| `cabin`    | Cabin number                               |                                                |
| `embarked` | Port of Embarkation                        | `C` = Cherbourg, `Q` = Queenstown, `S` = Southampton |

## Software

```{r message=FALSE}
library(tidyverse)
library(randomForest)
```

Additionally, we will use some components of the `data.table` package calling directly the namespace.

For ethnicity prediction we will use
```{r}
library(wru)
```




# 1. Data wrangling
In this process we will read the data and do a basic cleaning of the data.

## Reading the data
First of all, we need to read the data sets from the files:
```{r}
titanic.train <- data.table::fread("data/titanic_train.csv")
titanic.test <- data.table::fread("data/titanic_test.csv")
```

Since we are going to clean some features and perform feature engineering, we will bind the training and test data. We use the `bind_rows()` function from the `dplyr` package, as it matches columns by name, and any missing columns will be filled with `NA` (this is the case for `survived` in the test data set):
```{r}
titanic.full <- bind_rows(titanic.train, titanic.test)
names(titanic.full) <- tolower(names(titanic.full))
```

We will split again the data sets before we start building the predictive model.

Before doing anything with the data, let us have a look at it and its structure:
```{r}
glimpse(titanic.full)
```


## Checking missing values (`NA`s)

First of all, we check how many the full data set has:
```{r}
titanic.full %>%
	select( - survived) %>% 
	summarise_all(funs(sum(is.na(.))))
```

## Dealing with empty fields

But that's only half of the picture, as there are some features that have no content (they are empty), and need to be changed into `NA`s before dealing with them properly:
```{r}
titanic.full <- titanic.full %>%
	mutate_all(funs(replace(., . == "", NA)))
```

Now we can see that we are taking into consideration all actual `NA`s:
```{r}
titanic.full %>%
	select( - survived) %>% 
	summarise_all(funs(sum(is.na(.))))
```
We see three problematic features:
- `age` 
- `fare`
- `cabin`
- `embarked`

Notice that we have `r nrow(titanic.full)` observations. Dealing with `fare` and `embarked` should be relatively easy, so we will start with these. For `age` we need additional features that we will extract from the data, so we will deal with it later. In contrast, for `cabin` one could argue there is not enough data to perform a proper inference of the missing values, so we will not attempt it.

But before doing this, we will do some feature engineering to help us fill these `NA` data.

# 3. Name feature engineering

## Surnames and titles

The `name`s by themselves are quite obviously not going to be a good predictor, so we need to extract useful information from it. The two first obvious choices are 

a. Surnames
b. Titles (English honorifics)

To do this, we need to look at the structure of a name: `Surname, Title. Name Secondname`. Having this information, we can simply use regular expressions to extract these two new features:
```{r}
titanic.full <- titanic.full %>% 
	mutate(name = gsub("^((\\w+\\W+){4}\\w+).*$","\\1", name)) %>% 
	mutate(title = gsub("(.*, )|(\\..*)", "", name)) %>% 
	mutate(surname = gsub("(*,)|(\\,.*)", "", name))
```

Let us have a glance of the different `r length(unique(titanic.full$title))` titles:
```{r}
table(titanic.full$title)
```

We can notice the following things: 

- A few titles are military people, probably the crew of the ship; these will be put together into `Navy`.
- There a few rich/nobiliary people; these will generalised into `Sir` and `Lady` only.
- Some of the honorifics are French or Dutch; we will refactor this into the English standard.

```{r}
titanic.full$title <- titanic.full$title %>%
	plyr::revalue(c("Ms" = "Mrs",
									"Mme" = "Mrs",
									"Mlle" = "Miss"))
```

```{r}
titanic.full <- titanic.full %>% 
	mutate(
		title = ifelse(title %in% c("Dona", "Lady", "the Countess", "Jonkheer"), "Lady", title),
		title = ifelse(title %in% c("Don", "Sir"), "Sir", title),
		title = ifelse(title %in% c("Capt", "Major", "Col"), "Navy", title)
		)
```

Now we have a much more meaningful categorisation (only `r length(unique(titanic.full$title))` categories) of the `title`s:
```{r}
table(titanic.full$title)
```


## Ethnicities

Something that might be quite useful, not only as a feature by itself, but as an auxiliary variable to fill missing `age`s, is the ethnicity of the passengers.

First thing we do is to predict the ethnicity using US Census data (sadly, it is not possible to use data from 1912, but it will be hopefully be a good first approach to the problem):
```{r}
titanic.full <- wru::predict_race(titanic.full, surname.only = T)
```

This will give probabilities of being white, black, hispanic, asian, or other, based on the surname:
```{r}
head(titanic.full %>% select(surname, starts_with("pred.")))
```


Now all we need to do is to select the 
```{r}
titanic.full <- titanic.full %>% 
	mutate(ethnicity = colnames(titanic.full %>% select(starts_with("pred.")))
				 [max.col(titanic.full %>% select(starts_with("pred.")), ties.method="first")]
		) %>% 
	select(- starts_with("pred.")) %>% 
	mutate(ethnicity = as.factor(ethnicity))
```

```{r}
titanic.full$ethnicity <- titanic.full$ethnicity %>%
	plyr::revalue(c("pred.whi" = "White",
									"pred.bla" = "Black",
									"pred.asi" = "Asian",
									"pred.his" = "Hispanic",
									"pred.oth" = "Other"))
```


From the data, the first thing we see is that most of the passengers were white:
```{r}
titanic.full %>% 
	select(ethnicity, sex) %>% 
	table()
```

It could be interesting to see an overview of the survival ratio as a function of `ethnicity` and `sex`: 
```{r}
ggplot(drop_na_(titanic.full, "survived")) +
	aes(x = as.factor(ethnicity), fill = as.factor(survived)) +
	geom_bar(aes(y = ..count../sum(..count..)), position = "fill") +
	facet_grid(sex ~ .) +
	labs(fill = "Survived", x = "Ethnicity", y = "Renomalised proportion") +
	theme_bw()
```
This already lets us suspect that `sex` and `ethnicity` (especially the former) will have some influence on the survival chance.



<!-- Remember that we still have a missing `fare` value, so we need to categorise it this when we deal with it. -->


# 4. Economical feature engineering

First we will deal with the missing values that can be input by hand without an advanced inference model:

- `fare`
- `embarked`

## Missing fare value
Let us have a look at the passenger missing the `fare` feature:
```{r}
titanic.full[which(is.na(titanic.full$fare)),]
```
The relevant features to impute the `fare` would seem to be `pclass`, and `embarked`, so we will focus on those:
```{r}
titanic.full %>%
	filter(pclass == 3, embarked == "S", is.na(fare) == F) %>% 
	ggplot() +
		geom_histogram(aes(x = fare), binwidth = 1, 
									 fill = "white", colour = "black")
```

Looking at the histogram above, it would seem appropiate to impute the median `fare` for this `pclass` and `embarked` combination:
```{r}
titanic.full[which(is.na(titanic.full$fare)),]$fare <- 
	median(
	titanic.full %>%
		filter(pclass == 3, embarked == "S") %>% 
		select(fare) %>% 
		na.omit() %>% 
		unlist()
	)
```

## Fare categories

Let us see how many different unique values of `fare` are there and their distribution:
```{r}
length(unique(titanic.full$fare))

ggplot(titanic.full) +
	geom_histogram(aes(x = fare), binwidth = 5, 
								 fill = "white", colour = "black")
```

That is definitely way too many, but we can prettify this data by categorising the fares into ranges, looking at the quantiles of the `fare` distribution.
```{r}
quantile(titanic.full$fare, na.rm = T)
```

A reasonable division for `fare` could be: 
- `<= 10`
- `10 <= 20`
- `20 <= 30`
- `< 30`

```{r}
titanic.full <- titanic.full %>% 
	mutate(fare.range = cut(fare, breaks = c(-Inf, 10, 20, 30, Inf), 
													labels = c("<10", "10-20", "20-30", ">30")))
```

```{r}
table(is.na(titanic.full$fare.range))
```



## Embarkation place
Let us have a look at the passengers missing the `embarked` feature:
```{r}
titanic.full[which(is.na(titanic.full$embarked)),]
```

The relevant features to impute `embarked` would seem to be `pclass`, `fare`, and `fare.class` so we will focus on those:
```{r}
titanic.full %>% 
	filter(pclass == 1, 
				 fare.range == ">30", 
				 fare < 500,
				 is.na(embarked) == F) %>% 
ggplot() +
	geom_boxplot(aes(x = as.factor(embarked), y = fare)) +
	geom_hline(yintercept = titanic.full[which(is.na(titanic.full$embarked)), "fare"][1], 
						 linetype = "dashed", colour = "red") +
	labs(x = "Embarked", y = "Fare (USD)")
```

The decision is not obvious, but `C` (Cherbourg) seems to be a better value, as the `fare` value approaches more the median of this `embarked` class.
```{r}
titanic.full <- titanic.full %>% 
	mutate(embarked = ifelse(passengerid %in% c(62, 830),
													 "C", embarked))
```

# 5. Age missing values

Now that we have the `ethnicity`, we have more detailed information to predict the `age` of people based on `sex`, `title` (this can give insight into the age; for instance Master is used for young boys), and the former.

The idea is to replace the missing values by the mean of the combination group of `sex + ethnicity + title` to have more a more accurate representation:
```{r}
impute_group_median <- function(x) replace(x, is.na(x), median(x, na.rm = TRUE))

titanic.full <- titanic.full %>%
	plyr::ddply(~ sex + ethnicity + title, transform, age = impute_group_median(age))
```

Now we just check if there are any `NA`s that we could not impute with this method (for instance, a group without defined mean from the available data):
```{r}
table(is.na(titanic.full$age))
```

Everything is all right, so we will continue.

```{r}
titanic.full %>%
	select( - survived) %>% 
	summarise_all(funs(sum(is.na(.))))
```

# 6. Predictive model with Random Forest

## Factoring the data
One important thing in R is that if we need to deal with predictive models (or models in general)...
```{r}
titanic.full <- titanic.full %>% 
	mutate(survived = ifelse(survived == 1, "true", "false")) %>% 
	mutate_at(c("survived", "sex", "ticket", "cabin", "embarked", 
							"ethnicity", "title", "surname"), 
						funs(factor(.)))
```

```{r}
glimpse(titanic.full)
```




## Building the model

```{r}
titanic.full <- titanic.full %>% 
	arrange(passengerid) %>% 
	select(- c("name" ,"ticket", "cabin", "surname"))

titanic.train <- titanic.full[1:691,]
titanic.cv.test <- titanic.full[692:891,]
titanic.test <- titanic.full[892:1309,]
```


```{r}
rf.titanic <- randomForest(survived~., data = titanic.train %>% select(- c("passengerid")), 
													 na.action = na.omit, importance = TRUE)

cbind(as_tibble(rf.titanic$err.rate),
			trees = seq(1, 500, 1)) %>%
	ggplot() +
		aes(x = trees) +
		geom_line(aes(y = OOB, colour = "oob")) +
		geom_line(aes(y = true, colour = "true")) +
		geom_line(aes(y = false, colour = "false")) +
		scale_colour_manual(values = c("oob" = "black",
																	 "true" = "green",
																	 "false" = "red"
		)) +
		labs(x = "Trees", y = "Error", colour = "Error")
```

```{r}
importance    <- importance(rf.titanic)
varImportance <- data.frame(Variables = row.names(importance), 
                            Importance = round(importance[ ,'MeanDecreaseGini'],2))

# Create a rank variable based on importance
rankImportance <- varImportance %>%
  mutate(Rank = paste0('#',dense_rank(desc(Importance))))

# Use ggplot2 to visualize the relative importance of variables
ggplot(rankImportance, aes(x = reorder(Variables, Importance), 
    y = Importance, fill = Importance)) +
  geom_bar(stat='identity') + 
  labs(x = 'Variables') +
  coord_flip() + 
  theme_minimal()
```

## Cross validation
```{r}
titanic.cv.pred <- data.frame(passengerid = titanic.cv.test$passengerid, 
														survived = predict(rf.titanic, titanic.cv.test))

titanic.cv.real <- data.frame(passengerid = titanic.cv.test$passengerid, 
											survived = as.factor(titanic.cv.test$survived))

caret::confusionMatrix(data = titanic.cv.pred$survived, 
											 reference = titanic.cv.real$survived)
```

